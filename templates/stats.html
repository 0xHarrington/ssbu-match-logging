{% extends "base.html" %}

{% block title %}Statistics - Smash Match Logger{% endblock %}

{% block content %}
<div class="stats-container">
    <!-- Overview Section -->
    <section class="stats-section">
        <h2>Overview</h2>
        <div class="grid">
            <div class="stat-card highlight">
                <div class="stat-label">Total Games</div>
                <div class="stat-value" id="totalGames">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Shayne Wins</div>
                <div class="stat-value" id="shayneWins">0</div>
                <div class="stat-label" id="shayneWinRate">0% Win Rate</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Matt Wins</div>
                <div class="stat-value" id="mattWins">0</div>
                <div class="stat-label" id="mattWinRate">0% Win Rate</div>
            </div>
        </div>
    </section>

    <!-- Activity Section -->
    <section class="stats-section">
        <h2>Recent Activity</h2>
        <div class="grid">
            <div class="stat-card">
                <div class="stat-label">Last Game</div>
                <div class="stat-value" id="lastGameDate">-</div>
                <div class="stat-label" id="gamesThisWeek">0 games this week</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Current Streak</div>
                <div class="stat-value" id="currentStreak">-</div>
            </div>
        </div>
    </section>

    <!-- Character Usage Section -->
    <section class="stats-section">
        <h2>Character Usage</h2>
        <div class="grid">
            <div class="stat-card">
                <div class="stat-label">Most Played (Shayne)</div>
                <div class="stat-value" id="mostPlayedShayne">-</div>
            </div>

            <div class="stat-card">
                <div class="stat-label">Most Played (Matt)</div>
                <div class="stat-value" id="mostPlayedMatt">-</div>
            </div>
        </div>
    </section>

    <!-- Monthly Activity Chart -->
    <section class="stats-section">
        <h2>Games Played by Month</h2>
        <div class="card">
            <div id="weeklyActivityChart" class="chart"></div>
        </div>
    </section>

    <!-- Matchups Section -->
    <section class="stats-section">
        <h2>Top Matchups</h2>
        <div class="card">
            <div id="topMatchups" class="matchups-grid"></div>
        </div>
    </section>

    <!-- Character Win Rates Section -->
    <section class="stats-section">
        <h2>Character Win Rates</h2>
        <div class="stats-grid">
            <div class="stats-card">
                <h3>Shayne's Characters</h3>
                <div id="shayneCharacterStats" class="character-list"></div>
            </div>

            <div class="stats-card">
                <h3>Matt's Characters</h3>
                <div id="mattCharacterStats" class="character-list"></div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block styles %}
<style>
    .stats-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        max-width: 1080px;
        margin: 0 auto;
        padding: 2rem;
        box-sizing: border-box;
    }

    .stats-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .stats-section h2 {
        color: var(--fg-light);
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--bg-light);
    }

    .stat-card {
        background-color: var(--bg1);
        border-radius: var(--card-radius);
        padding: 1.5rem;
        text-align: center;
        transition: transform var(--transition-speed), box-shadow var(--transition-speed);
        border: 1px solid var(--bg-light);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .stat-card.highlight {
        background-color: var(--bg2);
        border-color: var(--blue);
    }

    .stat-card.shayne {
        border-color: #d65d0e;
        /* gruvbox orange */
    }

    .stat-card.matt {
        border-color: #98971a;
        /* gruvbox green */
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }

    .stat-value.shayne {
        color: #d65d0e;
        /* gruvbox orange */
    }

    .stat-value.matt {
        color: #98971a;
        /* gruvbox green */
    }

    .stat-label {
        color: var(--gray);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .win-rate.shayne {
        color: #d65d0e;
        /* gruvbox orange */
    }

    .win-rate.matt {
        color: #98971a;
        /* gruvbox green */
    }

    .win-bar.shayne {
        background-color: #d65d0e;
        /* gruvbox orange */
    }

    .win-bar.matt {
        background-color: #98971a;
        /* gruvbox green */
    }

    .matchups-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }

    .matchup-item {
        background-color: var(--bg2);
        border-radius: var(--card-radius);
        padding: 1.5rem;
        border: 1px solid var(--bg-light);
        transition: transform var(--transition-speed);
    }

    .matchup-item:hover {
        transform: translateY(-2px);
    }

    .matchup-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        color: var(--fg-light);
        font-weight: bold;
        font-size: 1.1rem;
    }

    .matchup-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    .matchup-stats>div {
        text-align: center;
    }

    .matchup-stats .win-count {
        color: var(--fg);
        font-size: 1.1rem;
        font-weight: 500;
    }

    .matchup-stats .win-percentage {
        color: var(--fg-dim);
        font-size: 0.9rem;
        opacity: 0.7;
    }

    .win-rate-bar {
        background-color: var(--bg-light);
        height: 8px;
        border-radius: 4px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .win-rate-fill {
        height: 100%;
        background-color: var(--blue);
        transition: width 0.3s ease;
    }

    .character-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .character-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background-color: var(--bg2);
        border-radius: var(--card-radius);
        border: 1px solid var(--bg-light);
        transition: transform var(--transition-speed);
    }

    .character-item:hover {
        transform: translateX(4px);
        background-color: var(--bg1);
    }

    .character-name {
        color: var(--fg);
        font-weight: 500;
    }

    .character-count {
        color: var(--blue);
        font-weight: bold;
        font-size: 1.1rem;
    }

    .chart {
        width: 100%;
        height: 400px;
    }

    .character-stats {
        margin-bottom: 1.5rem;
        padding: 1.25rem;
        background: var(--bg2);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .character-stats:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .character-name {
        font-weight: 600;
        color: var(--fg);
        font-size: 1.2rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-bar {
        display: flex;
        height: 32px;
        border-radius: 8px;
        overflow: hidden;
        background: var(--bg1);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .win-bar {
        background-color: var(--blue);
        color: white;
        padding: 0 1rem;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        font-size: 0.95rem;
        min-width: 50px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: width 0.3s ease;
    }

    .loss-bar {
        background-color: var(--bg-light);
        color: white;
        padding: 0 1rem;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        font-size: 0.95rem;
        min-width: 50px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        transition: width 0.3s ease;
    }

    .stats-total {
        font-size: 0.9rem;
        color: var(--fg-dim);
        text-align: right;
        font-weight: 500;
        margin-top: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 1rem;
    }

    .stats-total>span {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stats-total>span::before {
        content: '';
        display: block;
        width: 4px;
        height: 4px;
        background: var(--fg-dim);
        border-radius: 50%;
    }

    .win-rate {
        color: var(--blue);
        font-weight: 600;
    }

    .games-played {
        color: var(--fg-dim);
    }

    /* Stats Grid Layout */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 2.5rem;
        margin-top: 2rem;
        padding: 0 1rem;
    }

    .stats-card {
        background: var(--bg1);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--bg-light);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    .stats-card h3 {
        margin-top: 0;
        margin-bottom: 2rem;
        color: var(--fg);
        font-size: 1.4rem;
        text-align: center;
        font-weight: 600;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--bg-light);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .stats-section h2 {
            font-size: 1.25rem;
        }

        .stat-value {
            font-size: 2rem;
        }

        .matchups-grid {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 0 0.5rem;
        }

        .character-stats {
            margin-bottom: 1rem;
            padding: 1rem;
            gap: 0.75rem;
        }

        .stats-bar {
            height: 28px;
        }

        .win-bar,
        .loss-bar {
            font-size: 0.9rem;
            min-width: 45px;
            padding: 0 0.75rem;
        }

        .character-name {
            font-size: 1.1rem;
        }

        .stats-card {
            padding: 1.5rem;
        }

        .stats-card h3 {
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
        }
    }

    .radio-button input[type="radio"]:checked+label.shayne {
        background-color: #d65d0e;
        /* gruvbox orange */
        color: var(--bg0);
        border-color: #d65d0e;
    }

    .radio-button input[type="radio"]:checked+label.matt {
        background-color: #98971a;
        /* gruvbox green */
        color: var(--bg0);
        border-color: #98971a;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            if (data.success) {
                const stats = data.stats;

                // Update basic stats
                document.getElementById('totalGames').textContent = stats.total_games;

                // Shayne stats with red theme
                const shayneWins = document.getElementById('shayneWins');
                shayneWins.textContent = stats.shayne_wins;
                shayneWins.classList.add('shayne');
                shayneWins.parentElement.classList.add('shayne');

                const shayneWinRate = document.getElementById('shayneWinRate');
                shayneWinRate.textContent = `${stats.shayne_win_rate}% Win Rate`;
                shayneWinRate.classList.add('shayne');

                // Matt stats with green theme
                const mattWins = document.getElementById('mattWins');
                mattWins.textContent = stats.matt_wins;
                mattWins.classList.add('matt');
                mattWins.parentElement.classList.add('matt');

                const mattWinRate = document.getElementById('mattWinRate');
                mattWinRate.textContent = `${stats.matt_win_rate}% Win Rate`;
                mattWinRate.classList.add('matt');

                document.getElementById('mostPlayedShayne').textContent = stats.most_played_shayne || '-';
                document.getElementById('mostPlayedMatt').textContent = stats.most_played_matt || '-';

                // Update last game and recent activity
                if (stats.last_game_date) {
                    const lastGame = new Date(stats.last_game_date);
                    document.getElementById('lastGameDate').textContent = lastGame.toLocaleDateString();
                }
                document.getElementById('gamesThisWeek').textContent = `${stats.games_this_week} games this week`;

                // Update current streak
                const streakElement = document.getElementById('currentStreak');
                if (stats.current_streak && stats.current_streak.length > 0) {
                    streakElement.textContent = `${stats.current_streak.player} - ${stats.current_streak.length} games`;
                } else {
                    streakElement.textContent = 'No active streak';
                }

                // Update monthly activity chart
                const monthlyActivityData = {
                    x: stats.monthly_activity.map(item => item.month),
                    y: stats.monthly_activity.map(item => item.games),
                    type: 'bar',
                    marker: {
                        color: '#458588', // gruvbox blue
                        line: {
                            color: '#3c3836', // gruvbox bg1
                            width: 1
                        }
                    }
                };

                const monthlyActivityLayout = {
                    title: {
                        text: 'Games Played by Month',
                        font: {
                            color: '#ebdbb2' // gruvbox fg
                        }
                    },
                    xaxis: {
                        title: {
                            text: 'Month',
                            font: {
                                color: '#ebdbb2', // gruvbox fg
                                size: 14
                            }
                        },
                        tickfont: {
                            color: '#ebdbb2', // gruvbox fg
                            size: 12
                        },
                        gridcolor: '#3c3836', // gruvbox bg1
                        zerolinecolor: '#3c3836', // gruvbox bg1
                        linecolor: '#3c3836', // gruvbox bg1
                        tickcolor: '#ebdbb2', // gruvbox fg
                        tickmode: 'array',
                        ticktext: stats.monthly_activity.map(item => {
                            const [year, month] = item.month.split('-');
                            const monthName = new Date(year, month - 1).toLocaleString('default', { month: 'short' });
                            const yearShort = year.slice(-2);
                            return `${monthName}. '${yearShort}`;
                        }),
                        tickvals: stats.monthly_activity.map(item => item.month)
                    },
                    yaxis: {
                        title: {
                            text: 'Number of Games',
                            font: {
                                color: '#ebdbb2', // gruvbox fg
                                size: 14
                            }
                        },
                        tickfont: {
                            color: '#ebdbb2', // gruvbox fg
                            size: 12
                        },
                        gridcolor: '#3c3836', // gruvbox bg1
                        zerolinecolor: '#3c3836', // gruvbox bg1
                        linecolor: '#3c3836', // gruvbox bg1
                        tickcolor: '#ebdbb2' // gruvbox fg
                    },
                    paper_bgcolor: '#282828', // gruvbox bg0
                    plot_bgcolor: '#282828', // gruvbox bg0
                    font: {
                        color: '#ebdbb2' // gruvbox fg
                    },
                    bargap: 0.2,
                    bargroupgap: 0.1,
                    showlegend: false,
                    margin: {
                        l: 50,
                        r: 20,
                        t: 50,
                        b: 50
                    }
                };

                // Add custom CSS for Plotly
                const style = document.createElement('style');
                style.textContent = `
                    .js-plotly-plot .plotly .modebar {
                        background-color: #282828 !important;
                    }
                    .js-plotly-plot .plotly .modebar-btn {
                        color: #ebdbb2 !important;
                    }
                    .js-plotly-plot .plotly .modebar-btn:hover {
                        background-color: #3c3836 !important;
                    }
                    .js-plotly-plot .plotly .modebar-btn.active {
                        background-color: #3c3836 !important;
                    }
                    .js-plotly-plot .plotly .modebar-group {
                        background-color: #282828 !important;
                    }
                `;
                document.head.appendChild(style);

                Plotly.newPlot('weeklyActivityChart', [monthlyActivityData], monthlyActivityLayout);

                // Update top matchups
                const topMatchups = document.getElementById('topMatchups');
                topMatchups.innerHTML = stats.top_matchups
                    .map(matchup => {
                        const shayneWinRate = Math.round((matchup.shayne_wins / matchup.total_games) * 100);
                        const mattWinRate = Math.round((matchup.matt_wins / matchup.total_games) * 100);
                        return `
                        <div class="matchup-item">
                            <div class="matchup-header">
                                <span>${matchup.shayne_character} vs ${matchup.matt_character}</span>
                                <span>${matchup.total_games} games</span>
                            </div>
                            <div class="matchup-stats">
                                <div>
                                    <div>Shayne Wins</div>
                                    <div class="win-count">${matchup.shayne_wins}<span class="win-percentage"> (${shayneWinRate}%)</span></div>
                                    <div class="win-rate-bar">
                                        <div class="win-rate-fill" style="width: ${(matchup.shayne_wins / matchup.total_games * 100)}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div>Matt Wins</div>
                                    <div class="win-count">${matchup.matt_wins}<span class="win-percentage"> (${mattWinRate}%)</span></div>
                                    <div class="win-rate-bar">
                                        <div class="win-rate-fill" style="width: ${(matchup.matt_wins / matchup.total_games * 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `}).join('');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error loading stats:', error);
            document.querySelector('main').innerHTML = `
                <div class="error">
                    Error loading statistics. Please try again later.
                </div>
            `;
        }
    }

    async function loadCharacterWinRates() {
        try {
            const response = await fetch('/api/character_win_rates');
            const data = await response.json();

            if (data.success) {
                // Sort characters by total games played and take top 8 for each player
                const shayneTop8 = Object.entries(data.shayne)
                    .sort((a, b) => {
                        const totalA = parseInt(a[1].total);
                        const totalB = parseInt(b[1].total);
                        return totalB - totalA;
                    })
                    .slice(0, 8);

                const mattTop8 = Object.entries(data.matt)
                    .sort((a, b) => {
                        const totalA = parseInt(a[1].total);
                        const totalB = parseInt(b[1].total);
                        return totalB - totalA;
                    })
                    .slice(0, 8);

                const shayneHtml = shayneTop8.map(([character, stats]) => {
                    const winRate = Math.round((parseInt(stats.wins) / parseInt(stats.total)) * 100);
                    return `
                    <div class="character-stats">
                        <div class="character-name">${character}</div>
                        <div class="stats-bar">
                            <div class="win-bar shayne" style="width: ${(parseInt(stats.wins) / parseInt(stats.total) * 100)}%">
                                ${stats.wins}W
                            </div>
                            <div class="loss-bar" style="width: ${(parseInt(stats.losses) / parseInt(stats.total) * 100)}%">
                                ${stats.losses}L
                            </div>
                        </div>
                        <div class="stats-total">
                            <span class="win-rate shayne">${winRate}% WR</span>
                            <span class="games-played">${stats.total} games</span>
                        </div>
                    </div>
                `}).join('');

                const mattHtml = mattTop8.map(([character, stats]) => {
                    const winRate = Math.round((parseInt(stats.wins) / parseInt(stats.total)) * 100);
                    return `
                    <div class="character-stats">
                        <div class="character-name">${character}</div>
                        <div class="stats-bar">
                            <div class="win-bar matt" style="width: ${(parseInt(stats.wins) / parseInt(stats.total) * 100)}%">
                                ${stats.wins}W
                            </div>
                            <div class="loss-bar" style="width: ${(parseInt(stats.losses) / parseInt(stats.total) * 100)}%">
                                ${stats.losses}L
                            </div>
                        </div>
                        <div class="stats-total">
                            <span class="win-rate matt">${winRate}% WR</span>
                            <span class="games-played">${stats.total} games</span>
                        </div>
                    </div>
                `}).join('');

                document.getElementById('shayneCharacterStats').innerHTML = shayneHtml;
                document.getElementById('mattCharacterStats').innerHTML = mattHtml;
            } else {
                throw new Error(data.message || 'Failed to load character win rates');
            }
        } catch (error) {
            console.error('Error loading character win rates:', error);
            document.getElementById('shayneCharacterStats').innerHTML = `<div class="error">${error.message}</div>`;
            document.getElementById('mattCharacterStats').innerHTML = `<div class="error">${error.message}</div>`;
        }
    }

    // Load stats when the page loads
    document.addEventListener('DOMContentLoaded', loadStats);
    document.addEventListener('DOMContentLoaded', loadCharacterWinRates);
</script>
{% endblock %}