{% extends "base.html" %}

{% block title %}Smash Match Stats{% endblock %}

{% block styles %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background-color: var(--bg1);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .stat-card h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: var(--fg);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--blue);
    }

    .stat-label {
        font-size: 1rem;
        color: var(--fg);
        opacity: 0.8;
    }

    .chart-container {
        background-color: var(--bg1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .chart-container h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: var(--fg);
    }

    .chart {
        width: 100%;
        height: 400px;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
        color: var(--fg);
    }

    .error {
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
        color: var(--red);
    }

    .character-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    .player-stats h3 {
        margin-bottom: 1rem;
        color: var(--fg);
    }

    .character-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .character-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem;
        background: var(--bg);
        border-radius: 4px;
    }

    .character-name {
        color: var(--fg);
    }

    .character-count {
        color: var(--blue);
        font-weight: bold;
    }

    .streak-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        background-color: var(--green);
        color: white;
        border-radius: 4px;
        font-weight: bold;
        margin-left: 0.5rem;
    }

    .matchup-item {
        background: var(--bg);
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .matchup-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
    }

    .matchup-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        text-align: center;
    }

    .win-rate-bar {
        height: 4px;
        background: var(--bg-light);
        border-radius: 2px;
        margin-top: 0.5rem;
        overflow: hidden;
    }

    .win-rate-fill {
        height: 100%;
        background: var(--blue);
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-card">
        <h2>Total Games</h2>
        <div class="stat-value" id="totalGames">-</div>
        <div class="stat-label">Games played</div>
    </div>
    <div class="stat-card">
        <h2>Shayne Wins</h2>
        <div class="stat-value" id="shayneWins">-</div>
        <div class="stat-label">Win Rate: <span id="shayneWinRate">-</span>%</div>
    </div>
    <div class="stat-card">
        <h2>Matt Wins</h2>
        <div class="stat-value" id="mattWins">-</div>
        <div class="stat-label">Win Rate: <span id="mattWinRate">-</span>%</div>
    </div>
    <div class="stat-card">
        <h2>Current Streak</h2>
        <div class="stat-value" id="currentStreak">-</div>
        <div class="stat-label" id="streakPlayer">-</div>
    </div>
    <div class="stat-card">
        <h2>Most Played (Shayne)</h2>
        <div class="stat-value" id="mostPlayedShayne">-</div>
        <div class="stat-label">Character</div>
    </div>
    <div class="stat-card">
        <h2>Most Played (Matt)</h2>
        <div class="stat-value" id="mostPlayedMatt">-</div>
        <div class="stat-label">Character</div>
    </div>
    <div class="stat-card">
        <h2>Recent Activity</h2>
        <div class="stat-value" id="gamesThisWeek">-</div>
        <div class="stat-label">Games this week</div>
    </div>
    <div class="stat-card">
        <h2>Avg Stocks (Shayne)</h2>
        <div class="stat-value" id="avgStocksShayne">-</div>
        <div class="stat-label">When winning</div>
    </div>
    <div class="stat-card">
        <h2>Avg Stocks (Matt)</h2>
        <div class="stat-value" id="avgStocksMatt">-</div>
        <div class="stat-label">When winning</div>
    </div>
</div>

<div class="chart-container">
    <h2>Top Characters</h2>
    <div class="character-stats">
        <div class="player-stats">
            <h3>Shayne's Top Characters</h3>
            <div id="shayneTopChars" class="character-list"></div>
        </div>
        <div class="player-stats">
            <h3>Matt's Top Characters</h3>
            <div id="mattTopChars" class="character-list"></div>
        </div>
    </div>
</div>

<div class="chart-container">
    <h3>Games Played by Week</h3>
    <div id="weeklyActivityChart"></div>
</div>

<div class="chart-container">
    <h3>Top Matchups</h3>
    <div id="topMatchups"></div>
</div>

<div class="chart-container">
    <h2>Character Win Rates</h2>
    <div class="character-stats">
        <div class="player-stats">
            <h3>Shayne's Characters</h3>
            <div id="shayneWinRates" class="character-list"></div>
        </div>
        <div class="player-stats">
            <h3>Matt's Characters</h3>
            <div id="mattWinRates" class="character-list"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block scripts %}
<script>
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const data = await response.json();

            if (data.status === 'success') {
                const stats = data.data;

                // Update basic stats
                document.getElementById('totalGames').textContent = stats.total_games;
                document.getElementById('shayneWins').textContent = stats.shayne_wins;
                document.getElementById('mattWins').textContent = stats.matt_wins;
                document.getElementById('shayneWinRate').textContent = stats.shayne_win_rate;
                document.getElementById('mattWinRate').textContent = stats.matt_win_rate;
                document.getElementById('mostPlayedShayne').textContent = stats.most_played_shayne || 'N/A';
                document.getElementById('mostPlayedMatt').textContent = stats.most_played_matt || 'N/A';
                document.getElementById('gamesThisWeek').textContent = stats.games_this_week;
                document.getElementById('avgStocksShayne').textContent = stats.avg_stocks_shayne;
                document.getElementById('avgStocksMatt').textContent = stats.avg_stocks_matt;

                // Update current streak
                const streakElement = document.getElementById('currentStreak');
                const streakPlayerElement = document.getElementById('streakPlayer');
                if (stats.current_streak) {
                    streakElement.textContent = stats.current_streak.length;
                    streakPlayerElement.textContent = `${stats.current_streak.player} is on a ${stats.current_streak.length}-game win streak`;
                }

                // Update character lists
                const shayneTopChars = document.getElementById('shayneTopChars');
                const mattTopChars = document.getElementById('mattTopChars');

                shayneTopChars.innerHTML = stats.top_shayne_chars
                    .map(char => `
                        <div class="character-item">
                            <span class="character-name">${char.character}</span>
                            <span class="character-count">${char.games} games</span>
                        </div>
                    `).join('');

                mattTopChars.innerHTML = stats.top_matt_chars
                    .map(char => `
                        <div class="character-item">
                            <span class="character-name">${char.character}</span>
                            <span class="character-count">${char.games} games</span>
                        </div>
                    `).join('');

                // Update monthly activity chart
                const monthlyActivityData = {
                    x: stats.monthly_activity.map(item => item.month),
                    y: stats.monthly_activity.map(item => item.games),
                    type: 'bar',
                    marker: {
                        color: 'var(--blue)',
                        line: {
                            color: 'var(--bg-light)',
                            width: 1
                        }
                    }
                };

                const monthlyActivityLayout = {
                    title: 'Games Played by Month',
                    xaxis: {
                        title: 'Month',
                        titlefont: {
                            color: 'var(--fg)',
                            size: 14
                        },
                        tickfont: {
                            color: 'var(--fg)',
                            size: 12
                        },
                        gridcolor: 'var(--bg-light)',
                        zerolinecolor: 'var(--bg-light)'
                    },
                    yaxis: {
                        title: 'Number of Games',
                        titlefont: {
                            color: 'var(--fg)',
                            size: 14
                        },
                        tickfont: {
                            color: 'var(--fg)',
                            size: 12
                        },
                        gridcolor: 'var(--bg-light)',
                        zerolinecolor: 'var(--bg-light)'
                    },
                    paper_bgcolor: 'var(--bg1)',
                    plot_bgcolor: 'var(--bg1)',
                    font: {
                        color: 'var(--fg)'
                    },
                    titlefont: {
                        color: 'var(--fg)',
                        size: 16
                    },
                    bargap: 0.2,
                    bargroupgap: 0.1
                };

                Plotly.newPlot('weeklyActivityChart', [monthlyActivityData], monthlyActivityLayout);

                // Update top matchups
                const topMatchups = document.getElementById('topMatchups');
                topMatchups.innerHTML = stats.top_matchups
                    .map(matchup => `
                        <div class="matchup-item">
                            <div class="matchup-header">
                                <span>${matchup.shayne_character} vs ${matchup.matt_character}</span>
                                <span>${matchup.total_games} games</span>
                            </div>
                            <div class="matchup-stats">
                                <div>
                                    <div>Shayne Wins</div>
                                    <div>${matchup.shayne_wins}</div>
                                    <div class="win-rate-bar">
                                        <div class="win-rate-fill" style="width: ${(matchup.shayne_wins / matchup.total_games * 100)}%"></div>
                                    </div>
                                </div>
                                <div>
                                    <div>Matt Wins</div>
                                    <div>${matchup.matt_wins}</div>
                                    <div class="win-rate-bar">
                                        <div class="win-rate-fill" style="width: ${(matchup.matt_wins / matchup.total_games * 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');

                // Update character win rates
                const shayneWinRates = document.getElementById('shayneWinRates');
                const mattWinRates = document.getElementById('mattWinRates');

                shayneWinRates.innerHTML = stats.shayne_character_win_rates
                    .map(char => `
                        <div class="character-item">
                            <span class="character-name">${char.character}</span>
                            <span class="character-count">${char.win_rate}%</span>
                        </div>
                    `).join('');

                mattWinRates.innerHTML = stats.matt_character_win_rates
                    .map(char => `
                        <div class="character-item">
                            <span class="character-name">${char.character}</span>
                            <span class="character-count">${char.win_rate}%</span>
                        </div>
                    `).join('');
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error loading stats:', error);
            document.querySelector('.main-content').innerHTML = `
                <div class="error">
                    Error loading statistics. Please try again later.
                </div>
            `;
        }
    }

    // Load stats when the page loads
    document.addEventListener('DOMContentLoaded', loadStats);
</script>
{% endblock %}